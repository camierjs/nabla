NABLA = ${NABLA_BINARY_DIR}/nabla
TGT_FILE = ${NABLA_SOURCE_DIR}/tests/$(TGT)/$(TGT).n
#TGT_ADDITIONAL_FILES = ${NABLA_SOURCE_DIR}/tests/$(TGT)/luleshInlines.n

MESH = 16
#SIMD = avx
COLORS = aos
#PARALLEL = omp

############
# STATIONS #
CXX_RedHat-6-x86_64=/usr/local/intel/Compiler/14.0/144/bin/icc
CFLAGS_RedHat-6-x86_64=-finline -inline-forceinline -fno-alias -alias-const -no-ipo

#########
# Linux #
# export LD_LIBRARY_PATH=/opt/intel/lib/intel64:$LD_LIBRARY_PATH
#CXX_Linux=/opt/intel/bin/icc
#CFLAGS_Linux=-finline -inline-forceinline -fno-alias -alias-const -no-ipo -I/usr/include/x86_64-linux-gnu
CXX_Linux=/usr/bin/g++
CFLAGS_Linux=-finline -I/usr/include/x86_64-linux-gnu

###########
# GERMAIN #
# module load KNC
# export LD_LIBRARY_PATH=/usr/local/intel/Compiler/14.0/0.080/lib/mic/:$LD_LIBRARY_PATH
# OMP_NUM_THREADS=1  ./lulesh_mic_16_omp_mic
CXX_BullEL_6__x86_64=/usr/local/intel/Compiler/14.0/0.080/bin/icc
CFLAGS_BullEL_6__x86_64=-finline -inline-forceinline -fno-alias -alias-const -no-ipo


CXX=$(CXX_$(shell uname))
CFLAGS = -g -O2 -fopenmp -Wall $(SIMD_$(SIMD)_FLAGS) $(CFLAGS_$(shell uname)) $(MESH_FLAGS)

SIMD_std_FLAGS  = -DWARP_BIT=0 -mno-avx -mno-sse2 -malign-double
SIMD_sse_FLAGS  = -DWARP_BIT=1 -msse #4.2 #-mno-avx
SIMD_avx_FLAGS  = -DWARP_BIT=2 -mavx 
SIMD_avx2_FLAGS = -DWARP_BIT=2 -march=core-avx2
SIMD_mic_FLAGS  = -DWARP_BIT=3 -mmic



export X_EDGE_ELEMS = $(MESH)
export Y_EDGE_ELEMS = $(shell echo $(MESH)-1|bc -l)
export Z_EDGE_ELEMS = $(shell echo $(MESH)-1|bc -l)
export X_EDGE_TICK = $(shell echo "scale=6;1.125/($(MESH)+1)"|bc -l)
export Y_EDGE_TICK = $(shell echo "scale=6;1.125/$(MESH)"|bc -l)
export Z_EDGE_TICK = $(shell echo "scale=6;1.125/$(MESH)"|bc -l)
#$(1).$(2).$(3): export LENGTH = $$(shell echo "scale=6;($(1)*($(1)-1))/1000"|bc -l)
export LENGTH = $(shell echo 1.125)
export MESH_FLAGS = -DX_EDGE_ELEMS=$(X_EDGE_ELEMS) -DY_EDGE_ELEMS=$(Y_EDGE_ELEMS) -DZ_EDGE_ELEMS=$(Z_EDGE_ELEMS) -DX_EDGE_TICK=$(X_EDGE_TICK) -DY_EDGE_TICK=$(Y_EDGE_TICK) -DZ_EDGE_TICK=$(Z_EDGE_TICK) -DLENGTH=$(LENGTH)

all:$(TGT) $(NABLA) 

$(TGT).cc: $(TGT_FILE) $(NABLA)
	$(NABLA) $(LOG) --okina $(TGT) --$(SIMD) --$(COLORS) --$(PARALLEL) -i $(TGT_FILE) $(ADDITIONAL_NABLA_FILES)

$(TGT).o:$(TGT).cc $(TGT_FILE)
	$(CXX) -c $(CFLAGS) $(TGT).cc -o $(TGT).o

$(TGT):$(TGT).o $(TGT_FILE)
	$(CXX) -fopenmp $(SIMD_$(SIMD)_FLAGS) -o $(TGT)_$(MESH)_$(PARALLEL)_$(SIMD) $(TGT).o

cln:
	-rm -f *.o $(TGT).cc $(TGT).h $(TGT)

gen1:$(TGT).cc
#	$(CXX) -S -c $(CFLAGS) $(TGT).cc -o $(TGT).S
run1:$(TGT) $(NABLA) 
	LD_LIBRARY_PATH=/opt/intel/lib/intel64:$LD_LIBRARY_PATH \
	OMP_NUM_THREADS=1 CILK_NWORKERS=1 time ./$(TGT)_$(MESH)_$(PARALLEL)_$(SIMD)
run4:$(TGT) $(NABLA) 
	LD_LIBRARY_PATH=/opt/intel/lib/intel64:$LD_LIBRARY_PATH \
	OMP_NUM_THREADS=4 CILK_NWORKERS=4 time ./$(TGT)_$(MESH)_$(PARALLEL)_$(SIMD)
