NABLA = ${NABLA_BINARY_DIR}/nabla
TGT_FILE = ${NABLA_SOURCE_DIR}/tests/$(TGT)/$(TGT).n
TGT_FILE += $(ADDITIONAL_NABLA_FILES:%=${NABLA_SOURCE_DIR}/tests/$(TGT)/%)

SIMD = std
PARALLEL = seq

KOKKOS_DEVICES = "OpenMP"
KOKKOS_ARCH = "HSL"
include /usr/local/kokkos/Makefile.kokkos

SIMD_std_FLAGS = -std=c++11 -O2 -Wall -DNO_SSE2

LOG = -t #-v $(TGT).log

CXX = ${CMAKE_CXX_COMPILER}

CFLAGS = $(SIMD_std_FLAGS) -finline $(MESH_FLAGS) $(KOKKOS_CPPFLAGS) $(KOKKOS_CXXFLAGS)

export X_EDGE_ELEMS = $(MESH)
export Y_EDGE_ELEMS = $(MESH)
export Z_EDGE_ELEMS = $(MESH)
export X_EDGE_TICK = $(shell echo "scale=6;1.0/$(MESH)"|bc -l)
export Y_EDGE_TICK = $(shell echo "scale=6;1.0/$(MESH)"|bc -l)
export Z_EDGE_TICK = $(shell echo "scale=6;1.0/$(MESH)"|bc -l)
export LENGTH = $(shell echo 1.125)
export MESH_FLAGS = -DX_EDGE_ELEMS=$(X_EDGE_ELEMS) -DY_EDGE_ELEMS=$(Y_EDGE_ELEMS) -DZ_EDGE_ELEMS=$(Z_EDGE_ELEMS) -DX_EDGE_TICK=$(X_EDGE_TICK) -DY_EDGE_TICK=$(Y_EDGE_TICK) -DZ_EDGE_TICK=$(Z_EDGE_TICK) -DLENGTH=$(LENGTH)


all:$(TGT) $(NABLA) 

$(TGT).cc: $(TGT_FILE) $(NABLA)
	$(NABLA) $(LOG) --kokkos $(TGT) --std --$(PARALLEL) -i $(TGT_FILE)

$(TGT).o: $(KOKKOS_LINK_DEPENDS) $(KOKKOS_CPP_DEPENDS) $(TGT).cc $(TGT_FILE)
	$(CXX) $(ADDITIONAL_DEFINES) -c $(CFLAGS) $(TGT).cc -o $(TGT).o

$(TGT):$(TGT).o $(TGT_FILE)
	$(CXX) $(SIMD_std_FLAGS) -o $(TGT)_$(MESH)_$(PARALLEL) $(TGT).o $(KOKKOS_LDFLAGS) $(KOKKOS_LIBS)

cln:
	-rm -f *.o $(TGT).cc $(TGT).h $(TGT)

gen1:$(TGT).cc
run1:$(TGT) $(NABLA) 
	./$(TGT)_$(MESH)_$(PARALLEL)
run4:$(TGT) $(NABLA) 
	./$(TGT)_$(MESH)_$(PARALLEL)

#############
# DOT 2 PNG #
#############
png:
#	dot -Tpng $(TGT).dot -o $(TGT).png
	dot -O -Tpng $(TGT).time.dot
