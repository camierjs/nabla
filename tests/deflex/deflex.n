//with ‚Ñù;

// ****************************************************************************
// Œ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÇœÉœÑœÖœÜœáœàœâŒëŒíŒìŒîŒïŒñŒóŒòŒôŒöŒõŒúŒùŒûŒüŒ†Œ°Œ£Œ§Œ•Œ¶ŒßŒ®Œ©
// ‚àÄ ‚Ñù‚Ñï‚Ñ§ ¬≤¬≥‚àö¬Ω‚Öì¬º‚Öõ
// ****************************************************************************

const ‚Ñù œÄ=3.1415926535897932384626433832795028841971693993751;

const ‚Ñï binMax=100;
‚Ñù histo[binMax];
‚Ñù Œòbinning[binMax];

ofstream histoData("/tmp/histo.data");


// ****************************************************************************
// * Options
// ****************************************************************************
options{
  // Param√®tres d'entr√©e
  ‚Ñù option_ŒΩŒ¥t = 0.05; // Fr√©quence de collision x pas de temps
  Bool option_particle_frame = true;
  // Numerical options
  ‚Ñù option_Œµ_frame_change = 1.0e-15;
  ‚Ñù option_ŒìŒ± = 1.0+0.5;
  ‚Ñù option_ŒìŒ≤ = 2.0;
  // Yet required options for backend
  ‚Ñù option_Œ¥t_initial = 0.0001;
  ‚Ñù option_stoptime = 1.0;
};


// **************************************************************************
// * Forward declaration
// ****************************************************************************
void iniRandom(double,double);
double gamma_rand(void);


// **************************************************************************
// * Particles Variables
// ****************************************************************************
particles{
  // Rep√®re du laboratoire
  ‚Ñù Œ±Lab,Œ≤Lab,Œ≥Lab; // Cosinus directeurs
  // Rep√®re de la particule
  ‚Ñù Œ±,Œ≤,Œ≥;
};


// **************************************************************************
// * Globals
// ****************************************************************************
//global{  ‚Ñù seed;};


// ****************************************************************************
// * Initialization Part @ ]-‚àû,-0.0[
// ****************************************************************************
void iniGlobals(void) @ -5.0{
  Œ¥t=option_Œ¥t_initial;
  printf("\n[7m[iniGlobals] Œ¥t=%f[m", (double)Œ¥t);
  assert(Œ¥t>=0.0);
}

void iniRandom(void) @ -5.0 {
  info()<<"[7;37m[iniRandom][m";
  iniRandom(option_ŒìŒ±,option_ŒìŒ≤);
  //info()<<"\n"<<gamma_rand();
}

// ****************************************************************************
// * initialization Œ±, Œ≤ et Œ≥ dans le rep√®re du labo
// ****************************************************************************
‚àÄ particles void ini_Œ±Œ≤Œ≥(void)
  out (particle Œ±,Œ≤,Œ≥) @ -5.0 if (option_particle_frame) {
  if (uid==0) info()<<"[7;37m[ini_Œ±Œ≤Œ≥][m";
  Œ±=1.0;
  Œ≤=Œ≥=0.0;
 }


// ****************************************************************************
// * Compute loop @ ]+0,+‚àû[
// ****************************************************************************
void dbgLoop(void) @ 1.0 {
  printf("\n[7;36m[Loop] #%3d, time=%f[m", GlobalIteration,time);
}

// ****************************************************************************
// * particleFrameSampling, aucun in/out, on remplit l'histogramme directement
// ****************************************************************************
‚àÄ particles void particleFrameSampling(void) @ 2.0 {
  register Bool rejet=true;
  register ‚Ñù Œ∏S3,sinŒ∏S3;
  if (uid==0) info()<<"[7;37m[particleFrameSampling][m";
  do{
    // On utilise la m√™me graine & g√©n√©rateur pour toutes les particules
    // Attention √† la reproductibilit√©
    const ‚Ñù rndŒì = gamma_rand();
    const ‚Ñù rnd01 = drand48();
    const ‚Ñù Œ∏=Œ∏S3=‚àö(2.0*option_ŒΩŒ¥t*rndŒì);
    sinŒ∏S3=sin(Œ∏);
    rejet=(Œ∏>œÄ)||(sinŒ∏S3<rnd01*Œ∏);
  }while (rejet);
  //info()<<"["<<uid<<"] theta="<<Œ∏S3;
  const ‚Ñù cosŒ∏S3=cos(Œ∏S3);
  // Vecteur tangent œÑ au p√¥le de S¬≥, al√©atoire
  const ‚Ñù œÜ = 2.0*œÄ*drand48();
  const ‚Ñù Œº = -1.0+2.0*drand48();
  // Projection de S¬≥ dans S¬≤
  const ‚Ñù œÑx=Œº;
  const ‚Ñù œÑy=‚àö(1.0-Œº¬≤)*cos(œÜ);
  const ‚Ñù¬≥ Œ©S2=‚Ñù¬≥(cosŒ∏S3,œÑx*sinŒ∏S3,œÑy*sinŒ∏S3);
  const ‚Ñù absŒ©S2=norm(Œ©S2);
  const ‚Ñù¬≥ Œ©S2final=Œ©S2/absŒ©S2;
  //info()<<"[7;37m[particleFrameSampling] Œ©S2.x="<<Œ©S2final.x<<"[m";
  diagnosticSpectrum(acos(Œ©S2final.x));
}

  
// ****************************************************************************
// * changeFrameFromParticleToLab
// ****************************************************************************
‚àÄ particles void changeFrameFromParticleToLab(void)
  in (particle Œ±,Œ≤,Œ≥)
  inout (particle Œ±Lab,Œ≤Lab,Œ≥Lab) @ 4.0 if (!option_particle_frame){
  const ‚Ñù denom = 1.0-Œ±Lab¬≤;
  if (uid==0) info()<<"[7;37m[changeFrameFromeParticleToLab][m";
  if (abs(denom)>=option_Œµ_frame_change){
    const ‚Ñù sqrtDenom = ‚àö(denom);
    const ‚Ñù unsSqrtDenom = 1./sqrtDenom;
    const ‚Ñù Œ±p = Œ±*Œ±Lab-Œ≥*sqrtDenom;
    const ‚Ñù Œ≤p = Œ±*Œ≤Lab+(Œ±Lab*Œ≤Lab*Œ≥-Œ≥Lab*Œ≤)*unsSqrtDenom;
    const ‚Ñù Œ≥p = Œ±*Œ≥Lab+(Œ±Lab*Œ≤Lab*Œ≥+Œ≤Lab*Œ≤)*unsSqrtDenom;
    Œ±Lab = Œ±p;
    Œ≤Lab = Œ≤p;
    Œ≥Lab = Œ≥p;
  }else{
    Œ±Lab = Œ±*Œ±Lab;
    // A revoir !!
    Œ≤Lab = Œ≥;
    Œ≥Lab = Œ≤;
  }
}


// ****************************************************************************
// * Test for quit
// ****************************************************************************
void tstForQuit(void) @ 4.0 {
  info()<<"[7;37m[tstForQuit][m";
  //printf("\n\t[testForQuit] Iteration=%d, time=%f, delta_t=%f", GlobalIteration, time,Œ¥t);
  //if (time<option_stoptime) return;
  //printf("\n[7m[tstForQuit] Quit![m");
  ‚Ñù sum=0.0;
  for(int i=0;i<binMax;i+=1)
    sum+=histo[i];
  for(int i=0;i<binMax-1;i+=1){
    const ‚Ñù value = histo[i]/sum;
    const ‚Ñù x = ¬Ω*(Œòbinning[i]+Œòbinning[i+1]);
    const ‚Ñù y = value/(Œòbinning[i+1]-Œòbinning[i]);
    printf(" %f",y);
    histoData << "\t" << x << "\t" << y;
  }
  printf("\n[7m[tstForQuit] Sum=%f[m\n\r",sum);
  assert(sum==(‚Ñù)NABLA_NB_PARTICLES);
  exit;
}

