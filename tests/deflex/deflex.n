with â„;

// ****************************************************************************
// Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏ‚ÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰Î‘Î’Î“Î”Î•Î–Î—Î˜Î™ÎšÎ›ÎœÎÎÎŸÎ Î¡Î£Î¤Î¥Î¦Î§Î¨Î©
// âˆ€ â„â„•â„¤ Â²Â³âˆšÂ½â…“Â¼â…›
// ****************************************************************************

const â„ Ï€=3.1415926535897932384626433832795028841971693993751;

const â„• binMax=100;
â„ histo[binMax];
â„ Î˜binning[binMax];

ofstream histoData("/tmp/histo.data");


// ****************************************************************************
// * Options
// ****************************************************************************
options{
  // ParamÃ¨tres d'entrÃ©e
  â„ option_Î½Î´t = 0.05; // FrÃ©quence de collision x pas de temps
  Bool option_particle_frame = true;
  // Numerical options
  â„ option_Îµ_frame_change = 1.0e-15;
  â„ option_Î“Î± = 1.0+0.5;
  â„ option_Î“Î² = 2.0;
  // Yet required options for backend
  â„ option_Î´t_initial = 0.0001;
  â„ option_stoptime = 1.0;
};


// **************************************************************************
// * Forward declaration
// ****************************************************************************
void iniRandom(double,double);
double gamma_rand(void);


// **************************************************************************
// * Particles Variables
// ****************************************************************************
cells /*particles*/{
  // RepÃ¨re du laboratoire
  â„ Î±Lab,Î²Lab,Î³Lab; // Cosinus directeurs
  // RepÃ¨re de la particule
  â„ Î¸,cosÎ¸,sinÎ¸;
  â„ Ï†;
  â„ Î±,Î²,Î³;
};


// **************************************************************************
// * Globals
// ****************************************************************************
//global{  â„ seed;};


// ****************************************************************************
// * Initialization Part @ ]-âˆ,-0.0[
// ****************************************************************************
void iniHisto(void) @ -5.0 {
  const â„ binMaxf=(â„)binMax;
  info()<<"binMaxf="<<binMaxf;
  
  for(int i=1;i<binMax;i+=1){
    const â„ ir=(â„)i;
    histo[i]=0.0;
    Î˜binning[i]=2.0*Ï€*(ir-1.0)/(binMaxf-1.0);
    //info()<<"binning["<<i<<"]="<<Î˜binning[i]<<", ir="<<ir;
  }      
}

void iniRandom(void) @ -5.0 {
  iniRandom(option_Î“Î±,option_Î“Î²);
  //info()<<"\n"<<gamma_rand();
}

void iniGlobals(void) @ -5.0{
  Î´t=option_Î´t_initial;
  printf("\n\33[7m[iniGlobals] Î´t=%f\33[m", (double)Î´t);
  assert(Î´t>=0.0);
}


// ****************************************************************************
// * initialization Î±, Î² et Î³ dans le repÃ¨re du labo
// ****************************************************************************
âˆ€ cells /*particles*/ void ini_Î±Î²Î³(void) out (cell Î±,Î²,Î³) @ -5.0 if (option_particle_frame) {
  Î±=1.0;
  Î²=Î³=0.0;
 }


// ****************************************************************************
// * Compute loop @ ]+0,+âˆ[
// ****************************************************************************


void dbgLoop(void) @ 1.0 {
  printf("\n[36m[Loop] #%3d, time=%f[m", GlobalIteration,time);
}


// ****************************************************************************
// * 
// ****************************************************************************
âˆ€ cells /*particles*/ void particleFrameSampling(void) out (cell Î¸,cosÎ¸,sinÎ¸,Ï†) @ 2.0 {
  Bool rejet=true;
  while (rejet){
    // On utilise la mÃªme graine & gÃ©nÃ©rateur pour toutes les particules
    // Attention Ã  la reproductibilitÃ©
    const â„ rnd = gamma_rand();
    const â„ rnd01 = drand48();
    Î¸=âˆš(2.0*option_Î½Î´t*rnd);
    sinÎ¸=sin(Î¸);
    rejet=(Î¸>Ï€)||(sinÎ¸<rnd01*Î¸);
  }
  //info()<<"["<<uid<<"] theta="<<Î¸;
  cosÎ¸=cos(Î¸);
  Ï†=2.0*Ï€*drand48();
}


âˆ€ cells /*particles*/ void diagnosticSpectrum(void) @ 2.5 if (option_particle_frame){
  â„• j=0;
  while(Î¸>Î˜binning[j]) j+=1;
  assert(j<100);
  histo[j-1]+=1;
 }


// ****************************************************************************
// * 
// ****************************************************************************
âˆ€ cells /*particles*/ void computeCosines(void)
  in (cell cosÎ¸,sinÎ¸,Ï†)
  out (cell Î±,Î²,Î³) @ 3.0 if (!option_particle_frame){
  //const â„ Î¼ = -1.0 + 2.0*drand48();
  //Î± = ;
  //Î² = ;
  //Î³ = ;
}


// ****************************************************************************
// * 
// ****************************************************************************
âˆ€ cells /*particles*/ void changeFrameFromeParticleToLab(void)
  in (cell Î±,Î²,Î³) inout (cell Î±Lab,Î²Lab,Î³Lab) @ 4.0 if (!option_particle_frame){
  const â„ denom = 1.0-Î±LabÂ²;
  if (abs(denom)>=option_Îµ_frame_change){
    const â„ sqrtDenom = âˆš(denom);
    const â„ unsSqrtDenom = 1./sqrtDenom;
    const â„ Î±p = Î±*Î±Lab-Î³*sqrtDenom;
    const â„ Î²p = Î±*Î²Lab+(Î±Lab*Î²Lab*Î³-Î³Lab*Î²)*unsSqrtDenom;
    const â„ Î³p = Î±*Î³Lab+(Î±Lab*Î²Lab*Î³+Î²Lab*Î²)*unsSqrtDenom;
    Î±Lab = Î±p;
    Î²Lab = Î²p;
    Î³Lab = Î³p;
  }else{
    Î±Lab = Î±*Î±Lab;
    // A revoir !!
    Î²Lab = Î³;
    Î³Lab = Î²;
  }
}


// ****************************************************************************
// * Test for quit
// ****************************************************************************
void tstForQuit(void) @ 4.0 {
  //printf("\n\t[testForQuit] Iteration=%d, time=%f, delta_t=%f", GlobalIteration, time,Î´t);
  //if (time<option_stoptime) return;
  //printf("\n[7m[tstForQuit] Quit![m");
  {
    â„ sum=0.0;
    for(int i=0;i<binMax;i+=1)
      sum+=histo[i];
    for(int i=0;i<binMax;i+=1){
      const â„ value = histo[i]/sum;
      printf(" %f",value);
      histoData << "\t" << value;
    }
    printf("\n[7m[tstForQuit] Sum=%f[m\n\r",sum);
    //assert(sum==nbParticle);
  }
  exit;
}

